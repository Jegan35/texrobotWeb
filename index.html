<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Robot Web Controller</title>
    <style>
        :root {
            --bg-main: #1E1E2E;
            --bg-panel: #27273A;
            --border: #3f3f5f;
            --text-main: #FFFFFF;
            --accent-blue: #40C4FF;
            --accent-green: #00E676;
            --accent-red: #FF5252;
            --accent-purple: #9b59b6;
            --accent-yellow: #f39c12;
        }
        
        body {
            background-color: var(--bg-main);
            color: var(--text-main);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            user-select: none;
            -webkit-user-select: none;
        }

        /* --- Panels --- */
        .panel {
            background-color: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0px 4px 15px rgba(0, 0, 0, 0.3);
        }

        h2, h3 { margin-top: 0; }
        h2 { color: var(--text-main); display: inline-block; margin-bottom: 0;}
        h3 { 
            color: var(--accent-blue); 
            text-align: center; 
            font-size: 14px; 
            letter-spacing: 1px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        /* --- Header & Status --- */
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .ip-config {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .ip-config input { width: 140px; }

        .status-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            background-color: #1a1a24;
            padding: 12px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 15px;
            border: 1px solid var(--border);
            justify-content: space-between;
        }

        .status-item { display: flex; gap: 8px; align-items: center;}
        .status-val { font-weight: bold; padding: 2px 8px; border-radius: 4px; background: #32324A; }
        
        .ok { color: var(--accent-green); }
        .warn { color: var(--accent-yellow); }
        .err { color: var(--accent-red); }

        /* --- Global Buttons --- */
        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-bottom: 15px;
        }

        button {
            background-color: #32324A;
            color: white;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 12px 18px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.1s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            touch-action: manipulation;
        }
        
        button:active { transform: translateY(2px); box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        
        .btn-active { border: 2px solid white; box-shadow: 0 0 10px currentColor; opacity: 1.0; }
        
        .c-blue { background-color: #1a4b6b; border-color: var(--accent-blue); }
        .c-red { background-color: #552222; border-color: var(--accent-red); }
        .c-green { background-color: #113322; border-color: var(--accent-green); }
        .c-yellow { background-color: #664400; border-color: var(--accent-yellow); }
        .c-purple { background-color: #4a235a; border-color: var(--accent-purple); }

        .bg-red { background-color: var(--accent-red) !important; color: black !important;}
        .bg-green { background-color: var(--accent-green) !important; color: black !important;}

        /* --- Grid Layouts --- */
        .main-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        /* --- Inputs --- */
        input[type="number"], input[type="range"], input[type="text"], select {
            width: 100%;
            background-color: #0a0a12;
            color: white;
            border: 1px solid var(--border);
            padding: 10px;
            border-radius: 4px;
            box-sizing: border-box;
            font-family: monospace;
            font-size: 14px;
        }

        .setting-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }
        .setting-row label { flex: 1; font-size: 13px; color: #aaa;}
        .setting-row input, .setting-row select { flex: 1; }
        .setting-row button { padding: 10px; margin: 0; }

        /* --- Motion Pads --- */
        .pad-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .jog-btn {
            font-size: 18px;
            padding: 20px;
            background-color: #2E2E48;
        }
        
        .jog-btn.is-pressing {
            background-color: var(--accent-green);
            color: black;
            border-color: white;
            transform: scale(0.96);
        }

        .zero-grid {
            display: flex;
            gap: 5px;
            justify-content: space-between;
        }
        .zero-grid button {
            padding: 8px 0;
            width: 100%;
            font-size: 12px;
        }

    </style>
</head>
<body>

    <div class="panel">
        <div class="header-top">
            <h2>ROBOT CONTROLLER</h2>
            <div class="ip-config">
                <input type="text" id="ipInput" value="192.168.1.40">
                <button class="c-blue" onclick="connectWebSocket()">Connect</button>
            </div>
        </div>

        <div class="status-bar">
            <div class="status-item">WS: <span id="st-ws" class="status-val err">DISCONNECTED</span></div>
            <div class="status-item">Servo: <span id="st-servo" class="status-val err">OFF</span></div>
            <div class="status-item">Mode: <span id="st-mode" class="status-val warn">Unknown</span></div>
            <div class="status-item">Error: <span id="st-err" class="status-val ok">No error</span></div>
        </div>
    </div>

    <div class="panel">
        <h3>SYSTEM CONTROLS</h3>
        
        <div class="btn-group">
            <button id="btnAuto" class="c-blue" onclick="sendCommand('SET_AUTO')">AUTO</button>
            <button id="btnManual" class="c-blue" onclick="sendCommand('SET_MANUAL')">MANUAL</button>
            <button id="btnRemote" class="c-blue" onclick="sendCommand('SET_REMOTE')">REMOTE</button>
            <div style="width: 20px;"></div>
            <button id="btnSim" class="c-purple" onclick="sendCommand('SET_SIM')">SIM</button>
            <button id="btnReal" class="c-red" onclick="sendCommand('SET_REAL')">REAL</button>
        </div>

        <div class="btn-group">
            <button id="btnServo" class="c-yellow" onclick="sendCommand('TOGGLE_SERVO')">SERVO TOGGLE</button>
            <button id="btnStart" class="c-green" onclick="sendCommand('TOGGLE_START')">START</button>
            <button id="btnPause" class="c-yellow" onclick="sendCommand('TOGGLE_PAUSE')">PAUSE</button>
            <button id="btnHome" class="c-purple" onclick="sendCommand('TRIGGER_HOME')">üè† HOME</button>
            <div style="width: 20px;"></div>
            <button onclick="sendCommand('CLEAR_ERRORS')">CLR ERR</button>
            <button onclick="sendCommand('CLEAR_MARKS')">CLR MARKS</button>
            <button class="c-red" onclick="sendCommand('EXIT')">EXIT</button>
        </div>
    </div>

    <div class="main-grid">
        
        <div class="panel">
            <h3>SPEED & CONFIGURATION</h3>
            
            <div class="setting-row">
                <label>Global Override (%)</label>
                <input type="range" id="speedSlider" min="1" max="100" value="50" onchange="sendCommand('SET_GLOBAL_SPEED', this.value)">
                <span id="sliderVal" style="width: 40px; text-align: right; font-family: monospace;">50</span>
            </div>

            <div class="setting-row">
                <label>Linear Speed (mm/s)</label>
                <input type="number" id="mmSpeed" value="50.0" step="0.1">
                <button class="c-blue" onclick="sendCommand('SET_MM_SPEED', document.getElementById('mmSpeed').value)">Set</button>
            </div>

            <div class="setting-row">
                <label>Angular Speed (deg/s)</label>
                <input type="number" id="degSpeed" value="50.0" step="0.1">
                <button class="c-blue" onclick="sendCommand('SET_DEG_SPEED', document.getElementById('degSpeed').value)">Set</button>
            </div>

            <div class="setting-row">
                <label>Linear Inc (mm)</label>
                <input type="number" id="mmInc" value="1.0" step="0.1">
                <button class="c-blue" onclick="sendCommand('SET_MM_INC', document.getElementById('mmInc').value)">Set</button>
            </div>

            <div class="setting-row">
                <label>Angular Inc (deg)</label>
                <input type="number" id="degInc" value="1.0" step="0.1">
                <button class="c-blue" onclick="sendCommand('SET_DEG_INC', document.getElementById('degInc').value)">Set</button>
            </div>

            <div class="setting-row">
                <label>Reference Frame</label>
                <select id="frameSelect" onchange="sendCommand('SET_FRAME', this.value)">
                    <option value="Base">Base Frame</option>
                    <option value="Tool">Tool Frame</option>
                    <option value="User">User Frame</option>
                </select>
            </div>
            
            <br>
            <h3>MOTION TYPE</h3>
            <div class="btn-group" style="margin-top: 10px;">
                <button id="modeJog" class="c-green btn-active" onclick="setMotionType('JOG')">JOG (Hold)</button>
                <button id="modeMove" class="c-blue" onclick="setMotionType('MOVE')">MOVE (Click)</button>
            </div>
            <p style="font-size: 12px; color: #aaa; text-align: center; margin-top: 0;">Select how the direction pads behave.</p>
        </div>

        <div class="panel">
            <h3>CARTESIAN</h3>
            <div class="pad-grid">
                <button class="jog-btn" data-btn="X+">X +</button>
                <button class="jog-btn" data-btn="X-">X -</button>
                <button class="jog-btn" data-btn="Y+">Y +</button>
                <button class="jog-btn" data-btn="Y-">Y -</button>
                <button class="jog-btn" data-btn="Z+">Z +</button>
                <button class="jog-btn" data-btn="Z-">Z -</button>
                
                <button class="jog-btn" data-btn="Rx+">Rx +</button>
                <button class="jog-btn" data-btn="Rx-">Rx -</button>
                <button class="jog-btn" data-btn="Ry+">Ry +</button>
                <button class="jog-btn" data-btn="Ry-">Ry -</button>
                <button class="jog-btn" data-btn="Rz+">Rz +</button>
                <button class="jog-btn" data-btn="Rz-">Rz -</button>
            </div>
        </div>

        <div class="panel">
            <h3>JOINTS</h3>
            <div class="pad-grid">
                <button class="jog-btn" data-btn="J1+">J1 +</button>
                <button class="jog-btn" data-btn="J1-">J1 -</button>
                <button class="jog-btn" data-btn="J2+">J2 +</button>
                <button class="jog-btn" data-btn="J2-">J2 -</button>
                <button class="jog-btn" data-btn="J3+">J3 +</button>
                <button class="jog-btn" data-btn="J3-">J3 -</button>
                <button class="jog-btn" data-btn="J4+">J4 +</button>
                <button class="jog-btn" data-btn="J4-">J4 -</button>
                <button class="jog-btn" data-btn="J5+">J5 +</button>
                <button class="jog-btn" data-btn="J5-">J5 -</button>
                <button class="jog-btn" data-btn="J6+">J6 +</button>
                <button class="jog-btn" data-btn="J6-">J6 -</button>
            </div>
            
            <h3 style="margin-top: 25px; margin-bottom: 10px; padding-bottom: 5px;">ZERO AXIS</h3>
            <div class="zero-grid">
                <button class="c-red" onclick="sendCommand('ZERO_AXIS', 1)">J1</button>
                <button class="c-red" onclick="sendCommand('ZERO_AXIS', 2)">J2</button>
                <button class="c-red" onclick="sendCommand('ZERO_AXIS', 3)">J3</button>
                <button class="c-red" onclick="sendCommand('ZERO_AXIS', 4)">J4</button>
                <button class="c-red" onclick="sendCommand('ZERO_AXIS', 5)">J5</button>
                <button class="c-red" onclick="sendCommand('ZERO_AXIS', 6)">J6</button>
            </div>
        </div>

    </div>

    <script>
        let ws = null;
        let motionType = 'JOG'; 

        document.getElementById('speedSlider').addEventListener('input', function() {
            document.getElementById('sliderVal').innerText = this.value;
        });

        function setMotionType(type) {
            motionType = type;
            const btnJog = document.getElementById('modeJog');
            const btnMove = document.getElementById('modeMove');

            if (type === 'JOG') {
                btnJog.classList.add('c-green', 'btn-active');
                btnJog.classList.remove('c-blue');
                btnMove.classList.remove('c-green', 'btn-active');
                btnMove.classList.add('c-blue');
            } else {
                btnMove.classList.add('c-green', 'btn-active');
                btnMove.classList.remove('c-blue');
                btnJog.classList.remove('c-green', 'btn-active');
                btnJog.classList.add('c-blue');
            }
        }

     function connectWebSocket() {
            if (ws && ws.readyState !== WebSocket.CLOSED) {
                ws.close();
            }

            const ip = document.getElementById('ipInput').value;
            const wsUrl = `ws://${ip}:8080`;
            
            const stWs = document.getElementById("st-ws");
            stWs.innerText = "CONNECTING...";
            stWs.className = "status-val warn";

            try {
                ws = new WebSocket(wsUrl);

                ws.onopen = () => {
                    // Start in a pending state
                    stWs.innerText = "WAITING APPROVAL...";
                    stWs.className = "status-val warn";
                };

                ws.onclose = () => {
                    stWs.innerText = "DISCONNECTED";
                    stWs.className = "status-val err";
                };
                
                ws.onerror = () => {
                    stWs.innerText = "ERROR";
                    stWs.className = "status-val err";
                }

                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    
                    if (data.type === "connection_accepted") {
                        stWs.innerText = "CONNECTED";
                        stWs.className = "status-val ok";
                    }
                    else if (data.type === "connection_rejected") {
                        alert("ACCESS DENIED: " + data.message);
                        ws.close();
                        stWs.innerText = "REJECTED";
                        stWs.className = "status-val err";
                    }
                    else if (data.type === "force_disconnect") {
                        alert("DISCONNECTED: " + data.message);
                        ws.close();
                        stWs.innerText = "KICKED";
                        stWs.className = "status-val err";
                    }
                    else if (data.type === "status_update") {
                        updateUI(data);
                    }
                };
            } catch (err) {
                stWs.innerText = "INVALID IP";
                stWs.className = "status-val err";
            }
        }

        function sendCommand(cmd, value = "") {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ command: cmd, value: value.toString() }));
                console.log("Sent:", cmd, value);
            } else {
                console.warn("Cannot send command. WebSocket not open.");
            }
        }

        function updateUI(state) {
            document.getElementById("st-mode").innerText = state.mode;
            document.getElementById("st-mode").className = "status-val " + (state.mode === "Real" ? "err" : "ok");
            
            document.getElementById("st-servo").innerText = state.servo_on ? "ON" : "OFF";
            document.getElementById("st-servo").className = "status-val " + (state.servo_on ? "ok" : "err");
            
            const errSpan = document.getElementById("st-err");
            errSpan.innerText = state.error_message;
            errSpan.className = "status-val " + ((state.error_message === "No error" || state.error_message === "Error cleared") ? "ok" : "err");

            document.getElementById('btnSim').classList.toggle('btn-active', state.mode === 'Sim');
            document.getElementById('btnReal').classList.toggle('btn-active', state.mode === 'Real');

            const btnStart = document.getElementById('btnStart');
            if (state.started) {
                btnStart.classList.add('bg-red', 'btn-active');
                btnStart.classList.remove('c-green');
                btnStart.innerText = "STOP";
            } else {
                btnStart.classList.remove('bg-red', 'btn-active');
                btnStart.classList.add('c-green');
                btnStart.innerText = "START";
            }

            const btnPause = document.getElementById('btnPause');
            if (state.paused) {
                btnPause.classList.add('btn-active');
                btnPause.innerText = "RESUME";
            } else {
                btnPause.classList.remove('btn-active');
                btnPause.innerText = "PAUSE";
            }
        }

        const jogBtns = document.querySelectorAll('.jog-btn');
        
        jogBtns.forEach(btn => {
            const axis = btn.getAttribute('data-btn');

            btn.addEventListener('pointerdown', (e) => {
                e.preventDefault(); 
                btn.classList.add('is-pressing');
                
                if (motionType === 'JOG') {
                    sendCommand('BTN_PRESS', axis);
                } else if (motionType === 'MOVE') {
                    sendCommand('BTN_CLICK', axis);
                }
            });

            const handleRelease = (e) => {
                e.preventDefault();
                if (btn.classList.contains('is-pressing')) {
                    btn.classList.remove('is-pressing');
                    
                    if (motionType === 'JOG') {
                        sendCommand('BTN_RELEASE', axis);
                    }
                }
            };

            btn.addEventListener('pointerup', handleRelease);
            btn.addEventListener('pointerleave', handleRelease);
            btn.addEventListener('pointercancel', handleRelease);
        });

        connectWebSocket();
    </script>
</body>
</html>